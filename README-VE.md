
## First compile on VE


```
$ ./run stories15M.bin
[...]
achieved tok/s: 505.376344

$ ./run llama-2-7b-chat.bin
[...]
achieved tok/s: 11.756028
```

Ftrace for the small case:
```
FREQUENCY  EXCLUSIVE       AVER.TIME     MOPS   MFLOPS  V.OP  AVER.    VECTOR L1CACHE CPU PORT VLD LLC PROC.NAME  
           TIME[sec](  % )    [msec]                    RATIO V.LEN      TIME    MISS     CONF HIT E.%            

    76712     2.863( 83.8)     0.037   6906.2   3359.9  97.30 176.0     2.781   0.015    0.000   54.08 matmul$1
     9589     0.361( 10.6)     0.038   6845.7   3330.8  97.31 176.0     0.350   0.001    0.000   54.11  -thread0
     9589     0.358( 10.5)     0.037   6903.0   3359.2  97.32 176.0     0.350   0.002    0.000   54.08  -thread1
     9589     0.357( 10.5)     0.037   6917.5   3365.4  97.30 176.0     0.346   0.002    0.000   54.08  -thread2
     9589     0.358( 10.5)     0.037   6911.0   3361.8  97.29 176.0     0.344   0.002    0.000   54.08  -thread3
     9589     0.357( 10.5)     0.037   6918.0   3365.3  97.29 176.0     0.346   0.002    0.000   54.08  -thread4
     9589     0.358( 10.5)     0.037   6913.8   3363.0  97.28 176.0     0.345   0.002    0.000   54.08  -thread5
     9589     0.357( 10.4)     0.037   6925.7   3369.5  97.31 176.0     0.350   0.002    0.000   54.08  -thread6
     9589     0.357( 10.5)     0.037   6915.8   3364.4  97.30 176.0     0.350   0.002    0.000   54.08  -thread7
    10704     0.395( 11.5)     0.037   1521.6    608.3  86.83  50.8     0.284   0.004    0.000   58.99 transformer$1
     1338     0.050(  1.4)     0.037   1977.0    808.4  88.81  50.8     0.048   0.001    0.000   57.35  -thread0
     1338     0.050(  1.4)     0.037   1975.0    808.0  88.86  50.8     0.048   0.001    0.000   62.69  -thread1
     1338     0.049(  1.4)     0.037   1990.1    813.1  88.74  50.8     0.047   0.001    0.000   61.23  -thread2
     1338     0.050(  1.5)     0.037   1971.3    803.9  88.58  50.8     0.046   0.001    0.000   53.53  -thread3
     1338     0.049(  1.4)     0.037   1990.0    812.9  88.72  50.8     0.047   0.001    0.000   61.58  -thread4
     1338     0.049(  1.4)     0.037   1990.1    813.1  88.74  50.8     0.047   0.001    0.000   57.54  -thread5
     1338     0.049(  1.4)     0.037    131.3      0.0   0.00   0.0     0.000   0.000    0.000    0.00  -thread6
     1338     0.049(  1.4)     0.037    131.6      0.0   0.00   0.0     0.000   0.000    0.000    0.00  -thread7
        1     0.120(  3.5)   120.416   4103.5   1542.0  70.98 245.9     0.007   0.023    0.000   87.98 main
   236511     0.020(  0.6)     0.000   3180.8      0.0   0.00   0.0     0.000   0.001    0.000    0.00 compare
     9589     0.013(  0.4)     0.001   1007.5      0.0   0.00   0.0     0.000   0.005    0.000    0.00 matmul
      223     0.007(  0.2)     0.031  11009.1   6584.2  92.64 205.7     0.003   0.002    0.000   89.57 transformer
------------------------------------------------------------------------------------------------------------------
   333740     3.418(100.0)     0.010   6149.8   2952.3  96.01 166.3     3.075   0.050    0.000   54.46 total
```

Ftrace for the large case:
```
FREQUENCY  EXCLUSIVE       AVER.TIME     MOPS   MFLOPS  V.OP  AVER.    VECTOR L1CACHE CPU PORT VLD LLC PROC.NAME  
           TIME[sec](  % )    [msec]                    RATIO V.LEN      TIME    MISS     CONF HIT E.%            

   460800   160.440( 93.1)     0.348  43699.7  21653.2  99.10 256.0   159.236   0.585    0.000   50.26 matmul$1
    57600    20.076( 11.7)     0.349  43655.1  21631.1  99.10 256.0    19.906   0.069    0.000   50.26  -thread0
    57600    20.057( 11.6)     0.348  43696.1  21651.4  99.10 256.0    19.886   0.079    0.000   50.26  -thread1
    57600    20.050( 11.6)     0.348  43711.7  21659.1  99.10 256.0    19.894   0.069    0.000   50.26  -thread2
    57600    20.053( 11.6)     0.348  43705.3  21655.9  99.10 256.0    19.886   0.075    0.000   50.26  -thread3
    57600    20.046( 11.6)     0.348  43719.1  21662.8  99.10 256.0    19.906   0.074    0.000   50.26  -thread4
    57600    20.057( 11.6)     0.348  43694.6  21650.6  99.10 256.0    19.888   0.079    0.000   50.26  -thread5
    57600    20.051( 11.6)     0.348  43707.7  21657.1  99.10 256.0    19.924   0.068    0.000   50.26  -thread6
    57600    20.051( 11.6)     0.348  43708.1  21657.4  99.10 256.0    19.946   0.073    0.000   50.26  -thread7
    65536    11.162(  6.5)     0.170   4614.7   2013.1  95.44 128.3    10.909   0.070    0.000   59.32 transformer$1
     8192     1.394(  0.8)     0.170   4616.1   2014.3  95.47 128.3     1.375   0.009    0.000   59.32  -thread0
     8192     1.395(  0.8)     0.170   4614.8   2013.4  95.46 128.3     1.370   0.008    0.000   59.32  -thread1
     8192     1.395(  0.8)     0.170   4615.9   2013.2  95.43 128.3     1.353   0.009    0.000   59.32  -thread2
     8192     1.396(  0.8)     0.170   4613.8   2012.1  95.42 128.3     1.348   0.009    0.000   59.32  -thread3
     8192     1.394(  0.8)     0.170   4618.5   2014.4  95.43 128.3     1.354   0.009    0.000   59.32  -thread4
     8192     1.396(  0.8)     0.170   4612.9   2011.7  95.42 128.3     1.349   0.009    0.000   59.32  -thread5
     8192     1.396(  0.8)     0.170   4609.3   2011.3  95.47 128.3     1.382   0.009    0.000   59.32  -thread6
     8192     1.394(  0.8)     0.170   4616.4   2014.3  95.47 128.3     1.379   0.008    0.000   59.32  -thread7
        1     0.280(  0.2)   280.247   3622.9    760.7  40.08 231.1     0.011   0.027    0.000   84.47 main
  1721568     0.143(  0.1)     0.000   3227.1      0.0   0.00   0.0     0.000   0.005    0.000    0.00 compare
    57600     0.138(  0.1)     0.002    535.4      0.0   0.00   0.0     0.001   0.114    0.000    0.00 matmul
      256     0.130(  0.1)     0.510  46773.1  30442.2  99.07 256.0     0.082   0.040    0.000   35.71 transformer
------------------------------------------------------------------------------------------------------------------
  2305761   172.294(100.0)     0.075  41036.6  20318.1  99.06 254.1   170.238   0.841    0.000   50.30 total
```

Replaced matmul by cblas sgemm function: (18 token/s)
```
FREQUENCY  EXCLUSIVE       AVER.TIME     MOPS   MFLOPS  V.OP  AVER.    VECTOR L1CACHE CPU PORT VLD LLC PROC.NAME  
           TIME[sec](  % )    [msec]                    RATIO V.LEN      TIME    MISS     CONF HIT E.%            

    65536    11.071( 51.5)     0.169   4518.0   1950.6  95.19 128.1    10.764   0.072    0.000   58.97 transformer$1
     8192     1.395(  6.5)     0.170   4481.1   1935.0  95.22 128.1     1.356   0.012    0.000   58.97  -thread0
     8192     1.387(  6.4)     0.169   4506.5   1945.9  95.21 128.1     1.352   0.009    0.000   58.98  -thread1
     8192     1.386(  6.4)     0.169   4513.0   1947.9  95.17 128.1     1.332   0.009    0.000   58.97  -thread2
     8192     1.385(  6.4)     0.169   4514.1   1948.4  95.17 128.1     1.333   0.009    0.000   58.96  -thread3
     8192     1.381(  6.4)     0.169   4528.2   1954.8  95.19 128.1     1.341   0.009    0.000   58.97  -thread4
     8192     1.382(  6.4)     0.169   4525.7   1953.2  95.16 128.1     1.331   0.009    0.000   58.98  -thread5
     8192     1.378(  6.4)     0.168   4537.4   1959.4  95.22 128.1     1.361   0.008    0.000   58.98  -thread6
     8192     1.377(  6.4)     0.168   4538.9   1959.9  95.21 128.1     1.360   0.008    0.000   58.97  -thread7
    57600     9.858( 45.8)     0.171  91080.5  44053.2  99.68 249.1     9.195   0.516    0.000    9.60 matmul
      256     0.140(  0.6)     0.546   3394.7     59.0  11.21 171.7     0.006   0.003    0.000  100.00 sample_topp
   262400     0.122(  0.6)     0.000  16292.4   8807.0  94.54 147.5     0.089   0.017    0.000   99.71 softmax
    33024     0.019(  0.1)     0.001  28919.7  16517.2  97.25 191.6     0.015   0.002    0.000   99.82  -thread0
    32768     0.014(  0.1)     0.000  14243.8   7563.4  93.85 135.7     0.011   0.002    0.000   99.52  -thread1
    32768     0.014(  0.1)     0.000  14332.0   7601.8  93.75 135.7     0.010   0.002    0.000   99.91  -thread2
    32768     0.014(  0.1)     0.000  14556.8   7712.5  93.64 135.7     0.010   0.002    0.000   99.96  -thread3
    32768     0.015(  0.1)     0.000  14019.5   7419.6  93.54 135.7     0.010   0.002    0.000   99.61  -thread4
    32768     0.015(  0.1)     0.000  14135.4   7472.6  93.43 135.7     0.010   0.002    0.000   99.87  -thread5
    32768     0.015(  0.1)     0.000  13416.0   7084.5  93.33 135.7     0.011   0.002    0.000   99.41  -thread6
    32768     0.015(  0.1)     0.000  13549.7   7147.2  93.23 135.7     0.011   0.002    0.000   99.43  -thread7
  1341352     0.117(  0.5)     0.000   3056.9      0.0   0.00   0.0     0.000   0.009    0.000    0.00 compare
      256     0.111(  0.5)     0.432  50139.7  33382.3  98.96 256.0     0.070   0.029    0.000   21.85 transformer
        1     0.083(  0.4)    83.279   1073.6     98.4  27.61 256.0     0.000   0.021    0.000    2.41 main
    16640     0.014(  0.1)     0.001  40482.7  19887.7  98.21 256.0     0.012   0.004    0.000   66.74 rmsnorm
        1     0.000(  0.0)     0.121   1152.8      0.0   0.00   0.0     0.000   0.000    0.000    0.00 malloc_run_state
      256     0.000(  0.0)     0.000   1407.6      2.5   0.00   0.0     0.000   0.000    0.000    0.00 random_f32
      256     0.000(  0.0)     0.000   2223.8      0.0   0.00   0.0     0.000   0.000    0.000    0.00 random_u32
        1     0.000(  0.0)     0.024    308.2      0.0   0.00   0.0     0.000   0.000    0.000    0.00 free_run_state
        2     0.000(  0.0)     0.007    361.9      0.0   0.00   0.0     0.000   0.000    0.000    0.00 time_in_ms
        1     0.000(  0.0)     0.009    250.7      0.0   0.00   0.0     0.000   0.000    0.000    0.00 checkpoint_init_weights
------------------------------------------------------------------------------------------------------------------
  1744558    21.515(100.0)     0.012  44473.7  21422.4  99.34 232.6    20.137   0.671    0.000   13.26 total
```

Running without openmp: (4 token/s)
```
FREQUENCY  EXCLUSIVE       AVER.TIME     MOPS   MFLOPS  V.OP  AVER.    VECTOR L1CACHE CPU PORT VLD LLC PROC.NAME  
           TIME[sec](  % )    [msec]                    RATIO V.LEN      TIME    MISS     CONF HIT E.%            

    57600    49.343( 81.6)     0.857 145532.1  70406.0  99.71 249.1    49.284   0.075    0.000    9.54 matmul
      256    10.828( 17.9)    42.299   5120.1   2335.3  95.79 134.4    10.816   0.025    0.000   59.86 transformer
   262400     0.086(  0.1)     0.000  22844.2  12536.7  95.98 147.5     0.083   0.002    0.000  100.00 softmax
        1     0.082(  0.1)    82.253   1085.0     99.6  27.66 256.0     0.000   0.022    0.000    1.26 main
      256     0.076(  0.1)     0.297   3811.1    108.2  18.04 188.2     0.006   0.001    0.000  100.00 sample_topp
  1055874     0.051(  0.1)     0.000   3694.6      0.0   0.00   0.0     0.000   0.003    0.000    0.00 compare
    16640     0.014(  0.0)     0.001  39978.7  19691.9  98.46 256.0     0.011   0.006    0.000   66.73 rmsnorm
        1     0.000(  0.0)     0.118   1172.3      0.0   0.00   0.0     0.000   0.000    0.000    0.00 malloc_run_state
      256     0.000(  0.0)     0.000   1184.4      3.1   0.00   0.0     0.000   0.000    0.000    0.00 random_f32
      256     0.000(  0.0)     0.000   1822.0      0.0   0.00   0.0     0.000   0.000    0.000    0.00 random_u32
        1     0.000(  0.0)     0.020    350.6      0.0   0.00   0.0     0.000   0.000    0.000    0.00 free_run_state
        2     0.000(  0.0)     0.006    340.2      0.0   0.00   0.0     0.000   0.000    0.000    0.00 time_in_ms
        1     0.000(  0.0)     0.008    243.6      0.0   0.00   0.0     0.000   0.000    0.000    0.00 checkpoint_init_weights
------------------------------------------------------------------------------------------------------------------
  1393544    60.481(100.0)     0.043 119699.7  57881.2  99.67 246.7    60.200   0.135    0.000   10.04 total
```


